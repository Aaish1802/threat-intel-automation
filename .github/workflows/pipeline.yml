name: Threat Intel Automation

on:
  schedule:
    - cron: '0 2 * * *'     # Every day at 2:00 AM UTC
  workflow_dispatch:         # Allow manual trigger

jobs:
  run-threat-pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: pip install -r requirements.txt

      - name: Ingest Feeds
        run: python scripts/ingest_feeds.py

      - name: Extract IOCs
        run: python scripts/extract_iocs.py

      - name: Classify Threats
        run: python scripts/classify_threats.py

      - name: Generate Report
        run: python scripts/summarize_report.py
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}

      - name: Commit & Push Report
        run: |
          if [ -f report.md ]; then
            mkdir -p reports
            cp report.md reports/report_$(date +'%Y-%m-%d').md
            git config user.name "Report"
            git config user.email "c0939066@mylambton.ca"
            git add reports/
            git commit -m "Add daily threat report - $(date +'%Y-%m-%d')" || echo "No changes to commit"
            git push
          else
            echo "⚠️ report.md not found, skipping commit & push."
